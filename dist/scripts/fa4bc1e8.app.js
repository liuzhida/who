angular.module("imageupload",[]).directive("image",["$q",function(a){"use strict";var b=window.URL||window.webkitURL,c=function(){var a="fileupload-resize-area",b=document.getElementById(a);return b||(b=document.createElement("canvas"),b.id=a,b.style.visibility="hidden",document.body.appendChild(b)),b},d=function(a,b){var d=b.resizeMaxHeight||300,e=b.resizeMaxWidth||250,f=b.resizeQuality||.7,g=b.resizeType||"image/jpg",h=c(),i=a.height,j=a.width;j>i?j>e&&(i=Math.round(i*=e/j),j=e):i>d&&(j=Math.round(j*=d/i),i=d),h.width=j,h.height=i;var k=h.getContext("2d");return k.drawImage(a,0,0,j,i),h.toDataURL(g,f)},e=function(a,b){var c=new Image;c.onload=function(){b(c)},c.src=a},f=function(b){var c=a.defer(),d=new FileReader;return d.onload=function(a){c.resolve(a.target.result)},d.readAsDataURL(b),c.promise};return{restrict:"A",scope:{image:"=",resizeMaxHeight:"@?",resizeMaxWidth:"@?",resizeQuality:"@?",resizeType:"@?"},link:function(a,c,g){var h=function(b,c){e(b.url,function(e){var f=d(e,a);b.resized={dataURL:f,type:f.match(/:(.+\/.+);/)[1]},c(b)})},i=function(b){a.$apply(function(){g.multiple?a.image.push(b):a.image=b})};c.bind("change",function(c){g.multiple&&(a.image=[]);for(var d=c.target.files,e=0;e<d.length;e++){var j={file:d[e],url:b.createObjectURL(d[e])};f(d[e]).then(function(a){j.dataURL=a}),a.resizeMaxHeight||a.resizeMaxWidth?h(j,function(a){i(a)}):i(j)}})}}}]),angular.module("whoApp.directives",[]).controller("pmtAlertController",["$scope","$attrs",function(a,b){a.closeable="close"in b}]).factory("$alert",["$rootScope","$timeout",function(a,b){return{add:function(c){a._alerts=a._alerts||[],a._alerts.push(c),b(function(){var b=a._alerts.indexOf(c);a._alerts.splice(b,1)},3e3)}}}]).directive("pmtAlert",function(){return{restrict:"EA",controller:"pmtAlertController",templateUrl:"template/alert/alert.html",transclude:!0,replace:!0,scope:{type:"=",close:"&"}}}).run(["$templateCache",function(a){a.put("template/alert/alert.html","<div class='alert' ng-class='\"alert-\" + (type || \"warning\")'>\n    <button ng-show='closeable' type='button' class='close' ng-click='close()'>&times;</button>\n    <div ng-transclude></div>\n</div>\n")}]),angular.module("whoApp.services",[]).factory("dataService",["$http","$q","$rootScope",function(a,b){return{personDict:{},productDict:{},functionDict:{},login:function(b,c){return a.post("/api/v1/login",{username:b,password:c})},updateWandou:function(b){return a.post("/api/v1/person/"+b.id,b)},loadPerson:function(){if(_.isEmpty(this.personList)){var b=this;return a.get("/api/v1/list/person").then(function(a){return b.personList=a.data,a.data},function(){})}return this.personList},loadIdx:function(){if(_.isEmpty(this.areaList)||_.isEmpty(this.productList)){var c=this;return b.all([a.get("/api/v1/list/area"),a.get("/api/v1/list/product"),a.get("/api/v1/list/person"),a.get("/api/v1/list/function")]).then(function(a){c.areaList=a[0].data,c.productList=a[1].data,c.personList=a[2].data,c.functionList=a[3].data},function(){})}},loadWandou:function(b){if(_.isEmpty(this.personDict[b])){var c=this;return a.get("/api/v1/person/"+b,{cache:!0}).then(function(a){c.personDict[b]=a.data},function(){})}},loadProduct:function(b){if(_.isEmpty(this.productDict[b])){var c=this;return a.get("/api/v1/product/"+b,{cache:!0}).then(function(a){c.productDict[b]=a.data},function(){})}},loadFunction:function(b){if(_.isEmpty(this.functionDict[b])){var c=this;return a.get("/api/v1/function/"+b,{cache:!0}).then(function(a){c.functionDict[b]=a.data},function(){})}},loadArea:function(){},query:function(b){return a.get("/api/v1/query",{params:{word:b}})}}}]).factory("$configData",[function(){return{xingzuoList:"白羊座 金牛座 双子座 巨蟹座 狮子座 处女座 天平座 天蝎座 射手座 魔羯座 水瓶座 双鱼座".split(" "),provinceList:new Array("北京市","天津市","上海市","重庆市","河北省","山西省","内蒙古","辽宁省","吉林省","黑龙江省","江苏省","浙江省","安徽省","福建省","江西省","山东省","河南省","湖北省","湖南省","广东省","广西","海南省","四川省","贵州省","云南省","西藏","陕西省","甘肃省","青海省","宁夏","新疆","香港","澳门","台湾省")}}]).factory("$helper",[function(){return{}}]).factory("whoHttpInterceptor",["$q","$alert","$location","$rootScope",function(a,b,c,d){return{responseError:function(b){return 403===b.status&&c.url("/login"),a.reject(b)},request:function(a){return d.currentUser&&-1===a.url.indexOf("?")&&(a.url+="?uid="+d.currentUser.id),a}}}]).config(["$httpProvider",function(a){a.interceptors.push("whoHttpInterceptor")}]),angular.module("whoApp.controllers",["whoApp.services"]).controller("loginCtrl",["$scope","$rootScope","$timeout","dataService","$location",function(a,b,c,d,e){a.loginHandler=function(){a.errorMsg="",a.username&&a.password?d.login(a.username,a.password).then(function(){e.path("/")},function(){a.errorMsg="用户名或者密码错误， 请使用豌豆荚wiki帐号登录。"}):a.errorMsg="请先填写相关信息"}}]).controller("homeCtrl",["$scope","$rootScope","$timeout","$http","dataService","$filter",function(a,b,c,d,e,f){a.areaList=e.areaList,a.productList=e.productList,a.functionList=e.functionList,_.each(e.personList,function(a){a.img=f("checkImg2")(a.img)}),a.personList=e.personList}]).controller("wandouCtrl",["$scope","$rootScope","$timeout","$routeParams","dataService","$configData",function(a,b,c,d,e,f){a.xingzuoList=f.xingzuoList,a.provinceList=f.provinceList,a.wandouInfo=e.personDict[d.name],a.wandouInfo.socials||(a.wandouInfo.socials=[]),a.updateWandouInfoHandler=function(){e.updateWandou(a.wandouInfo).then(function(){a.isShowEditForm=!1})},a.$watch("imageUpload",function(b){if(b){var c=new FormData;c.append("file",a.imageUpload.file);var d=new XMLHttpRequest;d.open("POST","/api/v1/update"),d.send(c)}})}]).controller("areaCtrl",["$scope","$rootScope","$timeout","$http","$routeParams","$filter",function(a,b,c,d,e,f){d.get("/api/v1/area/"+e.name,{cache:!0}).then(function(b){_.each(b.data.members,function(a){a.img=f("checkImg2")(a.img)}),a.areaInfo=b.data})}]).controller("searchCtrl",["$scope","$rootScope","$timeout","$http","$routeParams","dataService","$filter",function(a,b,c,d,e,f,g){f.query(e.word).then(function(b){return 1===b.data.length&&_.isEmpty(b.data[0])?(console.log("NO RESULT"),void 0):(a.searchInfo=_.groupBy(b.data,function(a){return a.type}),_.each(a.searchInfo,function(a){_.each(a,function(a){a.color=g("getRandomColor")("color")})}),a.searchWord=e.word,void 0)})}]).controller("productCtrl",["$scope","$rootScope","$timeout","$http","$routeParams","dataService",function(a,b,c,d,e,f){a.productInfo=f.productDict[e.name]}]).controller("functionCtrl",["$scope","$rootScope","$timeout","$http","$routeParams","dataService",function(a,b,c,d,e,f){a.functionInfo=f.functionDict[e.name]}]).controller("navbarCtrl",["$scope","$rootScope","$location","$http",function(a,b,c){a.keydownHandler=function(b){13===b.keyCode&&c.path("/search/"+a.navbarQuery)},a.$watch("navbarQuery",function(a){a&&c.path("/search/"+a)})}]),angular.module("whoApp.filters",[]).filter("isEmpty",[function(){return function(a){return _.isEmpty(a)}}]).filter("checkImg",[function(){return function(a){return _.isEmpty(a)?"http://img.wdjimg.com/who/avatar0.png":a}}]).filter("checkImg2",[function(){return function(a){return _.isEmpty(a)?"http://img.wdjimg.com/who/avatar"+_.random(0,9)+".png":a}}]).filter("getRandomColor",[function(){return function(){var a=["c38867","ffc247","3baa24","4cc9b6","4e9ce6","ff7272","ff8f4b","9777d6"];return"#"+_.shuffle(a)[0]}}]);var app=angular.module("whoApp",["ngCookies","ngResource","ngSanitize","ngRoute","ngAnimate","ngTouch","ui.select2","whoApp.directives","whoApp.controllers","whoApp.filters","imageupload"]);app.config(["$routeProvider","$httpProvider","$locationProvider",function(a,b){b.defaults.withCredentials=!0,a.when("/",{templateUrl:"/views/home.html",controller:"homeCtrl",resolve:{load:["dataService",function(a){return a.loadIdx()}]}}).when("/login",{templateUrl:"/views/login.html",controller:"loginCtrl"}).when("/wandou/:name",{templateUrl:"/views/wandou.html",controller:"wandouCtrl",resolve:{load:["dataService","$route",function(a,b){return a.loadWandou(b.current.params.name)}]}}).when("/area/:name",{templateUrl:"/views/area.html",controller:"areaCtrl",resolve:{load:["dataService","$route",function(a,b){return a.loadArea(b.current.params.name)}]}}).when("/function/:name",{templateUrl:"/views/function.html",controller:"functionCtrl",resolve:{load:["dataService","$route",function(a,b){return a.loadFunction(b.current.params.name)}]}}).when("/product/:name",{templateUrl:"/views/product.html",controller:"productCtrl",resolve:{load:["dataService","$route",function(a,b){return a.loadProduct(b.current.params.name)}]}}).when("/search/:word",{templateUrl:"/views/search.html",controller:"searchCtrl"}).otherwise({redirectTo:"/",requireAuthentication:!1})}]).run(["$rootScope","$location","$http","$window",function(a,b,c,d){a.$on("$routeChangeSuccess",function(){c.get("/api/v1/current_user",{cache:!0}).then(function(b){a.currentUser=b.data},function(){})}),a.$on("$routeChangeStart",function(){d.scrollTo(0,0)})}]);